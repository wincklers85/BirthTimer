<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>BirthTimer Sweet Arrival Edition ‚Äî v3.1</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600&family=Pacifico&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f9f5ef;
  --fg:#2b2b2b;
  --accent:#c48a63;   /* cambia con tema */
  --card:#ffffff;
  --soft-shadow:0 4px 12px rgba(0,0,0,0.1);
}
body{
  margin:0; font-family:'Nunito Sans',sans-serif;
  background:var(--bg); color:var(--fg); text-align:center; overflow-x:hidden;
}
header{ padding:25px 10px; }
.logo{
  font-family:'Pacifico',cursive; font-size:2.2em; color:var(--accent);
  text-shadow:0 1px 3px rgba(0,0,0,0.15);
}
.sub{font-size:.9em;color:#666;}
.card{
  background:var(--card); box-shadow:var(--soft-shadow);
  border-radius:20px; padding:15px; margin:15px auto; max-width:500px;
}
button,input,select,textarea{
  font-family:'Nunito Sans',sans-serif; border-radius:12px; border:1px solid #ddd;
  padding:10px 15px; font-size:1em; margin:6px;
}
button{
  background:var(--accent); color:#fff; border:none; cursor:pointer;
  box-shadow:0 3px 6px rgba(0,0,0,0.15); transition:0.25s;
}
button.ghost{ background:#fff; color:var(--accent); border:1px solid var(--accent); }
button:hover{opacity:.9;transform:translateY(-2px);}
.bigBtn{ width:80%; height:80px; font-size:1.4em; border-radius:40px; margin-top:15px; }
#timerCircle{
  width:180px; height:180px; margin:20px auto 0; border-radius:50%; position:relative; background:#fff; box-shadow:var(--soft-shadow);
}
#timerText{ position:absolute; top:50%;left:50%; transform:translate(-50%,-50%); font-size:2em; font-weight:600; }
#progressRing{
  position:absolute; top:0;left:0; width:100%;height:100%; border-radius:50%; border:6px solid var(--accent);
  box-sizing:border-box; clip-path:polygon(50% 50%,50% 0,100% 0,100% 100%,0 100%,0 0,50% 0); transform:rotate(0deg);
}
#ecgCanvas{ width:100%; height:90px; margin-top:10px; }
footer{ font-size:.8em; margin:25px 0 10px; color:#777; }
.pattern{
  background-image:
    radial-gradient(rgba(196,138,99,0.15) 1.5px,transparent 1.5px),
    radial-gradient(rgba(196,138,99,0.15) 1.5px,transparent 1.5px);
  background-size:40px 40px; background-position:0 0,20px 20px;
}
.dark{ --bg:#1e1e1e; --fg:#eee; --card:#2c2c2c; --accent:#d6b47a; }
.hidden{display:none;}
table{width:100%;border-collapse:collapse;margin-top:10px;font-size:.9em;}
td,th{border-bottom:1px solid #ddd;padding:6px;text-align:center;}
canvas{width:100%;height:200px;margin-top:10px;}
#countdownInfo{margin-top:10px;font-size:.95em;color:#666;}
.badge{
  display:inline-block; padding:6px 10px; border-radius:999px; background:#fff; color:var(--accent);
  border:1px solid var(--accent); font-size:.85em; margin-top:6px;
}
.suggestions{ text-align:left; font-size:.95em; line-height:1.5; }
.suggestions li{ margin:6px 0; }
hr.sep{ border:none; border-top:1px dashed #d9c8b8; margin:12px 0; }
</style>
</head>
<body class="pattern">
<header>
  <div class="logo">BirthTimer Sweet Arrival</div>
  <div class="sub">Il giorno in cui sei arrivato</div>
</header>

<div id="app">
  <!-- SETUP -->
  <div id="setup" class="card">
    <h2>Impostazioni iniziali / Initial Setup</h2>
    <input id="mamma" placeholder="Nome Mamma / Mom name"><br>
    <input id="papa" placeholder="Nome Pap√† / Dad name"><br>
    <input id="bimbo" placeholder="Nome Bimbo/a / Baby name"><br>
    <label>Lingua / Language:</label>
    <select id="lang">
      <option value="it">Italiano</option>
      <option value="en">English</option>
    </select><br>
    <label>Tema:</label>
    <select id="themeSel">
      <option value="beige">ü§ç Beige</option>
      <option value="pink">üå∏ Rosa</option>
      <option value="blue">üíô Azzurro</option>
    </select><br>
    <button id="startApp">Inizia / Start</button>
  </div>

  <!-- MAIN -->
  <div id="main" class="hidden">
    <div id="phaseTitle" style="font-weight:700;margin-top:4px;"></div>
    <span id="phaseBadge" class="badge hidden"></span>

    <div id="timerCircle">
      <div id="progressRing"></div>
      <div id="timerText">00:00</div>
    </div>

    <canvas id="ecgCanvas" width="500" height="90"></canvas>

    <div style="margin-top:10px;">
      <button id="soundToggle" class="ghost">üîä Battito ON</button>
      <button id="darkToggle" class="ghost">üåô Modalit√† Notte</button>
    </div>

    <button id="startStop" class="bigBtn">Start</button>

    <div id="countdownInfo"></div>

    <div class="card" id="adviceCard">
      <h3>üí° Suggerimenti</h3>
      <ul id="suggestions" class="suggestions"></ul>
    </div>

    <div id="log" class="card">
      <h3>Storico / Log</h3>
      <table id="table">
        <tr><th>#</th><th>Ora</th><th>Durata</th><th>Intervallo</th><th>Fase</th></tr>
      </table>
      <button id="resetLog" class="ghost">‚ôªÔ∏è Reset Log</button>
    </div>

    <div id="diario" class="card">
      <h3>üìî Diario nascita</h3>
      <textarea id="noteText" rows="3" style="width:95%;border-radius:10px;border:1px solid #ccc;"></textarea><br>
      <input type="file" id="fotoInput" accept="image/*"><br>
      <button id="salvaNota">üíæ Aggiungi nota</button>
      <div id="listaNote" style="text-align:left;margin-top:10px;font-size:.9em;"></div>
    </div>

    <canvas id="chart"></canvas>

    <div class="card">
      <button id="exportBtn">üì§ Esporta Ricordo (HTML)</button>
      <button id="pdfBtn" class="ghost">üìÑ PDF Elegante</button>
    </div>
  </div>
</div>

<footer>BirthTimer v3.1 ‚Äî Created by <b>Stephan Winckler</b> ¬© 2025</footer>

<!-- Libs -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<script>
/* ====== VARIABILI ====== */
const el=id=>document.getElementById(id);
let data=[], startTime=null, timerInt=null, chart;
let ctxECG, x=0, bpm=60, audioCtx, nextBeep=0;
let theme="beige", lang="it", dark=false, soundOn=true;
let noteList=[];

/* ====== TEMA & DARK ====== */
function setTheme(t){
  theme=t;
  if(t==="pink"){ document.documentElement.style.setProperty("--accent","#d16b8c"); }
  else if(t==="blue"){ document.documentElement.style.setProperty("--accent","#3b82f6"); }
  else { document.documentElement.style.setProperty("--accent","#c48a63"); } // beige
}

/* ====== START ====== */
function startAppHandler(){
  lang = el("lang").value || "it";
  setTheme(el("themeSel").value || "beige");

  const info={ mamma:el("mamma").value, papa:el("papa").value, bimbo:el("bimbo").value, theme, lang };
  localStorage.setItem("birthInfo", JSON.stringify(info));

  el("setup").classList.add("hidden");
  el("main").classList.remove("hidden");

  initChart(); initECG(); updatePhase(); renderNotes(); refreshAdvice();
}
el("startApp").onclick = startAppHandler;
document.addEventListener("DOMContentLoaded", ()=>{
  const btn = document.getElementById("startApp");
  if(btn && !btn._bound){ btn.addEventListener("click", startAppHandler); btn._bound = true; }
});

/* ====== TIMER ====== */
function formatTime(ms){
  let s=Math.floor(ms/1000), m=Math.floor(s/60); s%=60;
  return `${m.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`;
}
function updateTimer(){ el("timerText").textContent = formatTime(Date.now()-startTime); }

el("startStop").onclick=()=>{
  if(!startTime){
    startTime=Date.now();
    timerInt=setInterval(updateTimer,100);
    el("startStop").textContent="Stop";
    bpm=120; nextBeep=0;
  }else{
    clearInterval(timerInt);
    const end=Date.now();
    let dur=end-startTime;
    let interval=data.length ? (end-data[data.length-1].end)/1000 : 0;
    let phase=calcPhase(interval, dur);
    data.push({start:startTime,end,dur,interval,phase});
    localStorage.setItem("birthData", JSON.stringify(data));
    renderTable(); updateChart(); updatePhase(); updateCountdown(); refreshAdvice();
    startTime=null; bpm=60;
    el("timerText").textContent="00:00";
    el("startStop").textContent="Start";
  }
};

/* ====== RESET LOG ====== */
el("resetLog").onclick=()=>{
  if(confirm("Sei sicuro di voler azzerare il log delle contrazioni?")){
    data=[]; localStorage.setItem("birthData","[]");
    renderTable(); updateChart(); updatePhase(); updateCountdown(); refreshAdvice();
  }
};

/* ====== PHASE pi√π precisa ======
   Usa media mobile su ultime 3 contrazioni:
   - Latente/Prodromica: intervallo >10 min o durata <30s
   - Early (7‚Äì10 min & 30‚Äì45s)
   - Attiva (4‚Äì6 min & 45‚Äì60s)
   - Transizione (2‚Äì3 min & 60‚Äì90s)
   + 5-1-1 segnala "ospedale"
*/
function movingAvg(arr, n){
  const slice = arr.slice(-n);
  return slice.length ? slice.reduce((a,b)=>a+b,0)/slice.length : 0;
}
function calcPhase(intervalSec, durMs){
  const lastIntervals = data.slice(-2).map(d=>d.interval).concat(intervalSec);
  const lastDurations = data.slice(-2).map(d=>d.dur).concat(durMs);
  const avgIntMin = movingAvg(lastIntervals,3)/60;
  const avgDurSec = movingAvg(lastDurations,3)/1000;

  if(avgIntMin>10 || avgDurSec<30) return lang=="it"?"Prodromica (latente)":"Latent";
  if(avgIntMin>7 && avgIntMin<=10 && avgDurSec>=30 && avgDurSec<45) return lang=="it"?"Early (inizio)":"Early";
  if(avgIntMin>4 && avgIntMin<=7  && avgDurSec>=45 && avgDurSec<=60) return lang=="it"?"Attiva":"Active";
  if(avgIntMin>2 && avgIntMin<=4  && avgDurSec>=60) return lang=="it"?"Transizione":"Transition";
  if(avgIntMin<=2) return lang=="it"?"Molto avanzata":"Very advanced";
  return lang=="it"?"In definizione":"Assessing";
}
function updatePhase(){
  const badge=el("phaseBadge");
  if(!data.length){
    el("phaseTitle").textContent = (lang=="it") ? "In attesa delle contrazioni..." : "Waiting for contractions...";
    badge.classList.add("hidden"); return;
  }
  const d=data[data.length-1];
  el("phaseTitle").textContent = (lang=="it") ? ("Fase: "+d.phase) : ("Phase: "+d.phase);
  badge.textContent = d.phase; badge.classList.remove("hidden");
}

/* ====== PROGRESS RING ====== */
function updateProgress(){
  const ring=el("progressRing");
  // proxy: pi√π contrazioni ‚Üí pi√π "progresso"
  let p=Math.min(data.length*5,100);
  ring.style.borderColor=`var(--accent)`;
  ring.style.transform=`rotate(${p*3.6}deg)`;
}

/* ====== COUNTDOWN ====== */
function updateCountdown(){
  if(data.length<3){ el("countdownInfo").textContent=""; return; }
  let intervals=data.slice(-5).map(d=>d.interval/60).filter(x=>x>0);
  let avg= intervals.reduce((a,b)=>a+b,0)/intervals.length;
  if(isNaN(avg)) return;
  let msg = (lang=="it")
   ? `Media intervallo ‚âà ${avg.toFixed(1)} min ‚Äî stima travaglio attivo ~${Math.max(0,((avg-5)*20)).toFixed(0)} min`
   : `Avg interval ‚âà ${avg.toFixed(1)} min ‚Äî active labour ETA ~${Math.max(0,((avg-5)*20)).toFixed(0)} min`;
  el("countdownInfo").textContent = msg;
}

/* ====== SUGGERIMENTI dinamici ====== */
function refreshAdvice(){
  const list=el("suggestions"); list.innerHTML="";
  if(!data.length){
    list.innerHTML = `
      <li>Riposo, idratazione, snack leggeri.</li>
      <li>Doccia calda o impacchi tiepidi per la schiena.</li>
      <li>Respiri profondi: 4 secondi inspiro, 6 espirazione.</li>`;
    return;
  }
  const last3 = data.slice(-3);
  const avgInt = movingAvg(last3.map(d=>d.interval), last3.length)/60;
  const avgDur = movingAvg(last3.map(d=>d.dur), last3.length)/1000;
  const oneHourAgo = Date.now()-60*60*1000;
  const inLastHour = data.filter(d=>d.start>=oneHourAgo);
  const rule511 = (avgInt<=5) && (avgDur>=60) && (inLastHour.length>=3);

  if(rule511){
    list.innerHTML = `
      <li><b>Regola 5-1-1 raggiunta:</b> contrazioni ogni ‚â§5 min, ‚â•1 min ciascuna, da ‚â•1 ora.</li>
      <li>√à il momento di andare in ospedale. Porta acqua e documenti.</li>
      <li>Mantieni i respiri regolari, evita sforzi inutili.</li>`;
  }else if(avgInt<=3){
    list.innerHTML = `
      <li>Contrazioni molto ravvicinate (‚â§3 min): partite subito per l‚Äôospedale.</li>
      <li>Respiri brevi-rapidi durante i picchi, profondi tra le onde.</li>
      <li>Posizioni in avanti (appoggio a un tavolo) aiutano il comfort.</li>`;
  }else if(avgInt<=5){
    list.innerHTML = `
      <li>Travaglio attivo: preparatevi a partire.</li>
      <li>Idratazione frequente, svuota la vescica regolarmente.</li>
      <li>Massaggi lombari e oscillazioni del bacino per alleviare la tensione.</li>`;
  }else{
    list.innerHTML = `
      <li>Fase iniziale: riposo, passeggiata leggera, musica soft (a casa).</li>
      <li>Doccia calda e respiro diaframmatico.</li>
      <li>Conserva energie, mangia qualcosa di facile da digerire.</li>`;
  }
}

/* ====== SOUND TOGGLE (solo beep battito) ====== */
el("soundToggle").onclick=()=>{
  soundOn=!soundOn;
  el("soundToggle").textContent = soundOn ? "üîä Battito ON" : "üîá Battito OFF";
};

/* ====== DARK MODE ====== */
el("darkToggle").onclick=()=>{
  dark=!dark; document.body.classList.toggle("dark",dark);
  el("darkToggle").textContent = dark ? "‚òÄÔ∏è Modalit√† Giorno" : "üåô Modalit√† Notte";
};

/* ====== ECG DINAMICO ====== */
function initECG(){
  const c=el("ecgCanvas"); ctxECG=c.getContext("2d");
  let last=performance.now();
  function loop(now){
    let delta=(now-last)/1000; last=now;
    ctxECG.fillStyle=getComputedStyle(document.documentElement).getPropertyValue("--bg");
    ctxECG.fillRect(0,0,c.width,c.height);
    ctxECG.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue("--accent");
    ctxECG.lineWidth=2; ctxECG.beginPath();
    let base=c.height/2, amp=12, speed=(bpm/60)*200;
    for(let i=0;i<c.width;i++){
      let y=base+Math.sin((x+i)/15)*amp*Math.sin(i/20);
      ctxECG.lineTo(i,y);
    }
    ctxECG.shadowBlur=8; ctxECG.shadowColor=ctxECG.strokeStyle;
    ctxECG.stroke(); ctxECG.shadowBlur=0; x+=speed*delta;

    if(soundOn && bpm>80){
      if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
      if(performance.now()>nextBeep){ beep(); nextBeep=performance.now()+(60000/bpm); }
    }
    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);
}
function beep(){
  if(!audioCtx) return;
  let o=audioCtx.createOscillator(), g=audioCtx.createGain();
  o.connect(g); g.connect(audioCtx.destination);
  o.frequency.value=600; g.gain.value=0.015;
  o.start(); o.stop(audioCtx.currentTime+0.04);
}

/* ====== LOG + GRAFICO ====== */
function renderTable(){
  let t=el("table");
  t.innerHTML="<tr><th>#</th><th>Ora</th><th>Durata</th><th>Intervallo</th><th>Fase</th></tr>";
  data.forEach((d,i)=>{
    let time=new Date(d.start).toLocaleTimeString();
    t.innerHTML+=`<tr><td>${i+1}</td><td>${time}</td><td>${formatTime(d.dur)}</td><td>${d.interval?Math.round(d.interval/60)+'m':""}</td><td>${d.phase}</td></tr>`;
  });
  updateProgress();
}
function initChart(){
  const c=document.getElementById("chart");
  chart=new Chart(c,{
    type:"line",
    data:{labels:[],datasets:[{label:"Durata (s)",data:[],borderColor:"var(--accent)",fill:false}]},
    options:{scales:{y:{beginAtZero:true}}}
  });
}
function updateChart(){
  chart.data.labels=data.map((_,i)=>i+1);
  chart.data.datasets[0].data=data.map(d=>Math.round(d.dur/1000));
  chart.update();
}

/* ====== DIARIO ====== */
function renderNotes(){
  const box=el("listaNote");
  let html="";
  noteList.forEach((n)=>{
    html+=`<div style="margin-bottom:10px;background:var(--card);padding:8px;border-radius:10px;">
      <b>${new Date(n.time).toLocaleString()}</b><br>${n.text||""}`;
    if(n.img) html+=`<br><img src="${n.img}" style="width:80px;border-radius:8px;margin-top:4px;">`;
    html+="</div>";
  });
  box.innerHTML = html || "<i>Nessuna nota</i>";
}
el("salvaNota").onclick=()=>{
  const txt=el("noteText").value.trim();
  const file=el("fotoInput").files[0];
  if(!txt && !file) return;

  let note={time:Date.now(),text:txt};
  if(file){
    const reader=new FileReader();
    reader.onload=e=>{
      note.img=e.target.result;
      noteList.push(note);
      localStorage.setItem("birthNotes", JSON.stringify(noteList));
      el("noteText").value=""; el("fotoInput").value="";
      renderNotes();
    };
    reader.readAsDataURL(file);
  }else{
    noteList.push(note);
    localStorage.setItem("birthNotes", JSON.stringify(noteList));
    el("noteText").value="";
    renderNotes();
  }
};

/* ====== EXPORT HTML ====== */
el("exportBtn").onclick=()=>{
  const info=JSON.parse(localStorage.getItem("birthInfo")||"{}");
  const accent=getComputedStyle(document.documentElement).getPropertyValue("--accent").trim()||"#c48a63";
  let html=`<html><head><title>BirthTimer Memory</title>
  <style>
  @import url('https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600&family=Pacifico&display=swap');
  body{font-family:'Nunito Sans',sans-serif;background:#fff6f0;color:#333;text-align:center;}
  h1{font-family:'Pacifico',cursive;color:${accent};margin-bottom:0}
  .frame{
    border:10px solid rgba(0,0,0,0.05); border-radius:24px; padding:20px; margin:20px;
    background:
      radial-gradient(rgba(0,0,0,0.03) 1.5px,transparent 1.5px) 0 0/40px 40px,
      radial-gradient(rgba(0,0,0,0.03) 1.5px,transparent 1.5px) 20px 20px/40px 40px;
  }
  .sub{color:#777;margin-top:0}
  table{width:92%;margin:auto;border-collapse:collapse;}
  td,th{border:1px solid #ddd;padding:6px;}
  .chip{display:inline-block;background:${accent}15;color:${accent};padding:4px 10px;border-radius:999px;margin:8px 0}
  </style></head><body>
  <div class='frame'>
  <div style="font-size:40px">üß∏‚≠êÔ∏èüß∏</div>
  <h1>BirthTimer ‚Äî Sweet Arrival</h1>
  <div class="sub">${info.mamma||"Mamma"} ‚ù§Ô∏è ${info.papa||"Pap√†"} ${info.bimbo?("‚Äî "+info.bimbo):""}</div>
  <div class="chip">Ricordo delle contrazioni</div>
  <table><tr><th>#</th><th>Ora</th><th>Durata</th><th>Intervallo</th><th>Fase</th></tr>`;
  data.forEach((d,i)=>{
    let time=new Date(d.start).toLocaleTimeString();
    html+=`<tr><td>${i+1}</td><td>${time}</td><td>${formatTime(d.dur)}</td><td>${d.interval?Math.round(d.interval/60)+'m':""}</td><td>${d.phase}</td></tr>`;
  });
  html+=`</table><h3>üìî Diario</h3>`;
  noteList.forEach(n=>{
    html+=`<p><b>${new Date(n.time).toLocaleString()}:</b> ${n.text||""}`;
    if(n.img)html+=`<br><img src='${n.img}' width='120' style='border-radius:12px;'>`;
    html+=`</p>`;
  });
  html+=`<p style='margin-top:25px;font-style:italic;color:#666;'>Il giorno in cui abbiamo contato ogni battito,<br>in attesa di incontrarti per la prima volta.</p>
  <p style='font-size:.85em;margin-top:22px;color:#999'>BirthTimer v3.1 ‚Äî Created by <b>Stephan Winckler</b> ¬© 2025</p>
  </div></body></html>`;
  const blob=new Blob([html],{type:"text/html"});
  const url=URL.createObjectURL(blob);
  window.open(url,"_blank");
};

/* ====== EXPORT PDF ELEGANTE con tema + frasi dinamiche ====== */
el("pdfBtn").onclick=()=>{
  const { jsPDF }=window.jspdf;
  const info=JSON.parse(localStorage.getItem("birthInfo")||"{}");
  const accent=getComputedStyle(document.documentElement).getPropertyValue("--accent").trim()||"#c48a63";

  // metriche dinamiche
  const intervals=data.map(d=>d.interval).filter(x=>x>0);
  const durations=data.map(d=>d.dur);
  const avgInt = intervals.length ? intervals.reduce((a,b)=>a+b,0)/intervals.length/60 : 0;
  const avgDur = durations.length ? durations.reduce((a,b)=>a+b,0)/durations.length/1000 : 0;
  const trend = (intervals.slice(-3).length>=3) ? (intervals.slice(-3)[0] > intervals.slice(-3)[2] ? "down" : "up") : "flat";
  const oneHourAgo = Date.now()-60*60*1000;
  const inLastHour = data.filter(d=>d.start>=oneHourAgo);
  const rule511 = (avgInt<=5) && (avgDur>=60) && (inLastHour.length>=3);

  // frasi dinamiche
  let phrase="";
  if(rule511) phrase = "Il ritmo racconta determinazione e forza: siete pronti ad accogliere il vostro piccolo, ogni respiro vi avvicina.";
  else if(avgInt && avgInt<=3) phrase = "Onde ravvicinate e intense: state navigando insieme l‚Äôultima tratta, con coraggio e presenza.";
  else if(avgInt && avgInt<=5) phrase = "Passi regolari verso l‚Äôincontro: idratazione, respiro e dolcezza rendono pi√π morbida la strada.";
  else phrase = "I primi segnali raccontano un viaggio che inizia: rispettate i tempi, curate la calma, ascoltatevi.";

  const doc=new jsPDF({unit:"pt", format:"a4"});
  // sfondo colore tema delicato
  doc.setFillColor(...hexToRgb(accent, 0.10)); // velatura
  doc.rect(0,0,595,842,"F");
  // cornice
  doc.setDrawColor(...hexToRgb(accent)); doc.setLineWidth(2);
  doc.roundedRect(24,24,595-48,842-48,14,14,"S");

  // intestazione decorata (orsacchiotti)
  doc.setFont("helvetica","bold"); doc.setTextColor(...hexToRgb(accent));
  doc.setFontSize(28); doc.text("BirthTimer ‚Äî Sweet Arrival", 48, 80);
  doc.setFontSize(12); doc.setTextColor(80); 
  let sub = `${info.mamma||"Mamma"} ‚ù§ ${info.papa||"Pap√†"} ${info.bimbo?(" ‚Äî "+info.bimbo):""}`;
  doc.text(sub,48,100);
  doc.setFontSize(24); doc.setTextColor(...hexToRgb(accent));
  doc.text("üß∏  ‚≠êÔ∏è  üß∏", 480, 80, {align:"right", baseline:"middle"});

  // riassunto
  doc.setTextColor(60); doc.setFontSize(12);
  doc.text(`Contrazioni registrate: ${data.length}`,48,130);
  if(avgInt) doc.text(`Intervallo medio: ${avgInt.toFixed(1)} min`, 48, 146);
  if(avgDur) doc.text(`Durata media: ${avgDur.toFixed(0)} s`, 48, 162);
  if(trend!=="flat"){
    const t = trend==="down" ? "in diminuzione (progresso)" : "in aumento (pausa)";
    doc.text(`Trend intervalli: ${t}`, 48, 178);
  }

  // frase dinamica
  doc.setFont("helvetica","italic"); doc.setTextColor(40); doc.setFontSize(13);
  const wrapped = doc.splitTextToSize(`‚Äú${phrase}‚Äù`, 595-96);
  doc.text(wrapped,48,208);

  // tabella log (semplice)
  let y=250; doc.setFont("helvetica","bold"); doc.setTextColor(30); doc.text("Registro contrazioni",48,y);
  y+=10; doc.setDrawColor(200); doc.line(48,y,595-48,y); y+=14;
  doc.setFont("helvetica","normal");
  data.forEach((d,i)=>{
    const line = `${(i+1).toString().padStart(2,"0")}  ‚Ä¢  ${new Date(d.start).toLocaleTimeString()}  ‚Ä¢  Dur: ${formatTime(d.dur)}  ‚Ä¢  Int: ${d.interval?Math.round(d.interval/60)+'m':'-'}  ‚Ä¢  ${d.phase}`;
    doc.text(line,48,y);
    y+=16; if(y>760){ doc.addPage(); y=64; }
  });

  // diario
  y+=8; if(y>760){ doc.addPage(); y=64; }
  doc.setFont("helvetica","bold"); doc.setTextColor(30); doc.text("Diario",48,y); y+=10; doc.setDrawColor(200); doc.line(48,y,595-48,y); y+=16;
  doc.setFont("helvetica","normal"); doc.setTextColor(50);
  noteList.forEach(n=>{
    const lines = doc.splitTextToSize(`‚Ä¢ ${new Date(n.time).toLocaleString()}: ${n.text||""}`, 595-96);
    lines.forEach(L=>{ doc.text(L,48,y); y+=14; if(y>760){ doc.addPage(); y=64; } });
  });

  // footer
  if(y>760){ doc.addPage(); y=64; }
  doc.setFont("helvetica","italic"); doc.setTextColor(90);
  doc.text("Il giorno in cui abbiamo contato ogni battito, in attesa di incontrarti per la prima volta.",48, 800);
  doc.setFont("helvetica","normal"); doc.setTextColor(120);
  doc.text("BirthTimer v3.1 ‚Äî Created by Stephan Winckler ¬© 2025",48, 820);

  doc.save("BirthTimer.pdf");

  function hexToRgb(hex, alpha){
    const h=hex.replace("#",""); const bigint=parseInt(h,16);
    const r=(bigint>>16)&255, g=(bigint>>8)&255, b=bigint&255;
    if(alpha!==undefined) return [r,g,b,alpha*255/255]; return [r,g,b];
  }
};

/* ====== INIT ====== */
window.onload=()=>{
  const info=JSON.parse(localStorage.getItem("birthInfo")||"{}");
  const saved=JSON.parse(localStorage.getItem("birthData")||"[]");
  noteList=JSON.parse(localStorage.getItem("birthNotes")||"[]");
  renderNotes();

  if(info.mamma){
    setTheme(info.theme||"beige"); lang=info.lang||"it"; data=saved;
    el("setup").classList.add("hidden"); el("main").classList.remove("hidden");
    initChart(); renderTable(); updateChart(); updatePhase(); updateCountdown(); refreshAdvice(); initECG();
  }else{
    el("setup").classList.remove("hidden");
  }
  const h=new Date().getHours();
  if(h>=21||h<6){ document.body.classList.add("dark"); dark=true; el("darkToggle").textContent="‚òÄÔ∏è Modalit√† Giorno"; }

  // toggles
  el("soundToggle").onclick=()=>{ soundOn=!soundOn; el("soundToggle").textContent = soundOn ? "üîä Battito ON" : "üîá Battito OFF"; };
  el("darkToggle").onclick=()=>{ dark=!dark; document.body.classList.toggle("dark",dark); el("darkToggle").textContent = dark ? "‚òÄÔ∏è Modalit√† Giorno" : "üåô Modalit√† Notte"; };
};
</script>
</body>
</html>
